version: '3.8'

# í”„ë¡œë•ì…˜ ë™ë“± í™˜ê²½ í…ŒìŠ¤íŠ¸ìš© Docker Compose
# t2.micro (1 vCPU, 1GB RAM) ìŠ¤í™ ì‹œë®¬ë ˆì´ì…˜

services:
  batch-test:
    build:
      context: .
      dockerfile: ./batch/Dockerfile
    container_name: batch-production-parity

    # ğŸ”¥ t2.microì™€ ë™ì¼í•œ ë¦¬ì†ŒìŠ¤ ì œí•œ
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=local

      # Database (í”„ë¡œë•ì…˜ DB ë˜ëŠ” ë¡œì»¬ DB)
      - DB_URL=jdbc:postgresql://${DB_HOST:-host.docker.internal}:${DB_PORT:-5432}/${DB_NAME:-techinsights}
      - DB_USERNAME=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-local_password}

      # JVM ë©”ëª¨ë¦¬ ì„¤ì • + JMX Exporter (t2.microì™€ ë™ì¼)
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xlog:gc*:file=/app/logs/gc.log:time,level,tags -javaagent:/app/jmx_prometheus_javaagent.jar=5556:/app/jmx-config.yml

      # Batch Job
      - SPRING_BATCH_JOB_NAME=${JOB_NAME:-crawlPostJob}

    # í¬íŠ¸ ë…¸ì¶œ (JMX Exporter Prometheus ë©”íŠ¸ë¦­)
    ports:
      - "5556:5556"  # JMX Exporter (ì›¹ ì„œë²„ ì•„ë‹˜!)

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸ (ë¡œê·¸ ìˆ˜ì§‘)
    volumes:
      - ./batch-logs:/app/logs
      - ./batch-reports:/app/reports

    # ë„¤íŠ¸ì›Œí¬
    networks:
      - batch-network

    # ë¡œê·¸ ì„¤ì •
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "java"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  batch-network:
    driver: bridge
