version: '3.8'

# í”„ë¡œë•ì…˜ ë™ë“± í™˜ê²½ í…ŒìŠ¤íŠ¸ìš© Docker Compose
# t2.micro (1 vCPU, 1GB RAM) ìŠ¤í™ ì‹œë®¬ë ˆì´ì…˜

services:
  batch-test:
    build:
      context: .
      dockerfile: ./batch/Dockerfile
    container_name: batch-production-parity

    # ğŸ”¥ t2.microì™€ ë™ì¼í•œ ë¦¬ì†ŒìŠ¤ ì œí•œ
    deploy:
      resources:
        limits:
          cpus: '1.0'         # 1 vCPU (t2.micro)
          memory: 1G          # 1GB RAM (t2.micro)
        reservations:
          cpus: '0.5'         # ìµœì†Œ 0.5 CPU ë³´ì¥
          memory: 512M        # ìµœì†Œ 512MB ë³´ì¥

    # CPU ì¿¼í„° ì œí•œ (ë” ì •ë°€í•œ ì œì–´)
    cpus: 1.0
    mem_limit: 1g
    mem_reservation: 512m

    # ë©”ëª¨ë¦¬ ìŠ¤ì™‘ ë¹„í™œì„±í™” (í”„ë¡œë•ì…˜ê³¼ ë™ì¼)
    memswap_limit: 1g

    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=local

      # Database (í”„ë¡œë•ì…˜ DB ë˜ëŠ” ë¡œì»¬ DB)
      - DB_HOST=${DB_HOST:-host.docker.internal}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-techinsights}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-password}

      # JVM ë©”ëª¨ë¦¬ ì„¤ì • (t2.microì™€ ë™ì¼)
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/app/logs/gc.log

      # Batch Job
      - SPRING_BATCH_JOB_NAMES=${JOB_NAME:-crawlPostJob}

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸ (ë¡œê·¸ ìˆ˜ì§‘)
    volumes:
      - ./batch-logs:/app/logs
      - ./batch-reports:/app/reports

    # ë„¤íŠ¸ì›Œí¬
    networks:
      - batch-network

    # ë¡œê·¸ ì„¤ì •
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "java"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ (Prometheus + Grafana)
  prometheus:
    image: prom/prometheus:latest
    container_name: batch-prometheus
    profiles:
      - monitoring
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - batch-network

  grafana:
    image: grafana/grafana:latest
    container_name: batch-grafana
    profiles:
      - monitoring
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards
    networks:
      - batch-network
    depends_on:
      - prometheus

networks:
  batch-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
